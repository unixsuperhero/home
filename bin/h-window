#!/usr/bin/env ruby

require 'hiiro'

Hiiro.run(*ARGV, plugins: [Pins]) do
  tmux = tmux_client

  add_subcmd(:ls) { |*args|
    if args.empty?
      tmux.windows.each { |w| puts w.to_s }
    else
      system('tmux', 'list-windows', *args)
    end
  }

  add_subcmd(:lsa) { |*args|
    if args.empty?
      tmux.windows(all: true).each { |w| puts w.to_s }
    else
      system('tmux', 'list-windows', '-a', *args)
    end
  }

  add_subcmd(:new) { |name = nil, *args|
    if args.empty?
      tmux.new_window(name: name)
    else
      system('tmux', 'new-window', *[name && "-n", name, *args].compact)
    end
  }

  add_subcmd(:kill) { |target = nil, *args|
    if target.nil?
      target = fuzzyfind_from_map(tmux.windows(all: true).name_map)
    end

    if target && args.empty?
      tmux.kill_window(target)
    elsif target
      system('tmux', 'kill-window', '-t', target, *args)
    end
  }

  add_subcmd(:rename) { |*args|
    system('tmux', 'rename-window', *args)
  }

  add_subcmd(:swap) { |*args|
    system('tmux', 'swap-window', *args)
  }

  add_subcmd(:move) { |*args|
    system('tmux', 'move-window', *args)
  }

  add_subcmd(:select) { |target = nil, *args|
    if target.nil?
      target = fuzzyfind_from_map(tmux.windows(all: true).name_map)
    end

    if target
      print target
    end
  }

  add_subcmd(:copy) { |target = nil, *args|
    if target.nil?
      target = fuzzyfind_from_map(tmux.windows(all: true).name_map)
    end

    if target
      Hiiro::Shell.pipe(target, 'pbcopy')
      puts "Copied window '#{target}' to clipboard"
    end
  }

  add_subcmd(:sw, :switch) { |target = nil, *args|
    if target.nil?
      target = fuzzyfind_from_map(tmux.windows(all: true).name_map)
    end

    if target
      tmux.open_session(target)
    end
  }

  add_subcmd(:next) { |*args|
    if args.empty?
      tmux.next_window
    else
      system('tmux', 'next-window', *args)
    end
  }

  add_subcmd(:prev) { |*args|
    if args.empty?
      tmux.previous_window
    else
      system('tmux', 'previous-window', *args)
    end
  }

  add_subcmd(:last) { |*args|
    if args.empty?
      tmux.last_window
    else
      system('tmux', 'last-window', *args)
    end
  }

  add_subcmd(:link) { |*args|
    system('tmux', 'link-window', *args)
  }

  add_subcmd(:unlink) { |target = nil, *args|
    if target && args.empty?
      tmux.unlink_window(target)
    else
      system('tmux', 'unlink-window', *[target && "-t", target, *args].compact)
    end
  }

  add_subcmd(:info) { |target = nil|
    window = if target
      tmux.windows(all: true).find { |w| w.target == target || w.name == target }
    else
      tmux.current_window
    end

    if window
      puts window.to_s
    else
      puts "Window not found"
    end
  }
end
